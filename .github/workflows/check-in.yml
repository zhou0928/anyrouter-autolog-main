name: AnyRouter 自动签到

on:
  # 定时执行：每6小时执行一次（北京时间 0:00, 6:00, 12:00, 18:00）
  schedule:
    - cron: '0 */6 * * *'
  
  # 手动触发
  workflow_dispatch:

jobs:
  check-in:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Python 环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: 缓存 pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml', '**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 安装项目依赖
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install python-dotenv requests playwright
          fi

      - name: 安装 Playwright 浏览器（通过 pip + CLI 安装，以避免 Action 弃用问题）
        run: |
          python -m pip install --upgrade pip
          python -m pip install playwright
          # 安装浏览器及其系统依赖
          python -m playwright install --with-deps

      - name: 校验关键 Secrets
        run: |
          if [ -z "${{ secrets.ANYROUTER_ACCOUNTS }}" ]; then
            echo "ERROR: Missing required secret ANYROUTER_ACCOUNTS"; exit 1
          fi
          echo "INFO: ANYROUTER_ACCOUNTS is set"

      - name: 创建配置文件 (.env)
        env:
          ANYROUTER_ACCOUNTS: ${{ secrets.ANYROUTER_ACCOUNTS }}
          PROVIDERS: ${{ secrets.PROVIDERS }}
          ALWAYS_NOTIFY: ${{ secrets.ALWAYS_NOTIFY }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          CUSTOM_SMTP_SERVER: ${{ secrets.CUSTOM_SMTP_SERVER }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          DINGDING_WEBHOOK: ${{ secrets.DINGDING_WEBHOOK }}
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
          WEIXIN_WEBHOOK: ${{ secrets.WEIXIN_WEBHOOK }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          SERVERPUSHKEY: ${{ secrets.SERVERPUSHKEY }}
        run: |
          echo "ANYROUTER_ACCOUNTS=$ANYROUTER_ACCOUNTS" > .env
          [ -n "$PROVIDERS" ] && echo "PROVIDERS=$PROVIDERS" >> .env
          [ -n "$ALWAYS_NOTIFY" ] && echo "ALWAYS_NOTIFY=$ALWAYS_NOTIFY" >> .env
          [ -n "$EMAIL_USER" ] && echo "EMAIL_USER=$EMAIL_USER" >> .env
          [ -n "$EMAIL_PASS" ] && echo "EMAIL_PASS=$EMAIL_PASS" >> .env
          [ -n "$CUSTOM_SMTP_SERVER" ] && echo "CUSTOM_SMTP_SERVER=$CUSTOM_SMTP_SERVER" >> .env
          [ -n "$EMAIL_TO" ] && echo "EMAIL_TO=$EMAIL_TO" >> .env
          [ -n "$DINGDING_WEBHOOK" ] && echo "DINGDING_WEBHOOK=$DINGDING_WEBHOOK" >> .env
          [ -n "$FEISHU_WEBHOOK" ] && echo "FEISHU_WEBHOOK=$FEISHU_WEBHOOK" >> .env
          [ -n "$WEIXIN_WEBHOOK" ] && echo "WEIXIN_WEBHOOK=$WEIXIN_WEBHOOK" >> .env
          [ -n "$PUSHPLUS_TOKEN" ] && echo "PUSHPLUS_TOKEN=$PUSHPLUS_TOKEN" >> .env
          [ -n "$SERVERPUSHKEY" ] && echo "SERVERPUSHKEY=$SERVERPUSHKEY" >> .env
          echo '--- .env preview ---'
          sed -n '1,120p' .env || true

      - name: 恢复余额状态
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: balance-hash
          path: .
      
      - name: 执行签到
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          DINGDING_WEBHOOK: ${{ secrets.DINGDING_WEBHOOK }}
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
          WEIXIN_WEBHOOK: ${{ secrets.WEIXIN_WEBHOOK }}
          SERVERPUSHKEY: ${{ secrets.SERVERPUSHKEY }}
          CUSTOM_SMTP_SERVER: ${{ secrets.CUSTOM_SMTP_SERVER }}
        run: |
          python checkin.py

      - name: 保存余额状态
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: balance-hash
          path: balance_hash.txt
          retention-days: 90
